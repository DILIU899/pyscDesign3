# scdesign test
```{r}
library(scDesign3)
example_sce <- readRDS("./test/test_data/exampledata1.rds")
# example_sce <- example_sce[1:100, ]
example_sce <- example_sce[1:3, ]

PANCREAS_data <- construct_data(
    sce = example_sce,
    assay_use = "counts",
    celltype = "cell_type",
    pseudotime = "pseudotime",
    spatial = NULL,
    other_covariates = NULL,
    corr_by = "1"
  )

# m=3 means the spline order(degree) is 3
PANCREAS_marginal <- fit_marginal(
    data = PANCREAS_data,
    predictor = "gene",
    mu_formula = "s(pseudotime, k=10, m=3, bs = 'bs')",
    sigma_formula = "1",
    family_use = "nb",
    n_cores = 1,
    usebam = FALSE,
    trace = TRUE
  )

sapply(PANCREAS_marginal,function(x){x$time[1]})
sapply(PANCREAS_marginal,function(x){x$fit$aic})
```

plot
```{r}
library(ggplot2)
library(mgcv)

x = PANCREAS_data$dat$pseudotime
count = as.data.frame(PANCREAS_data$count_mat)
for (gene in names(PANCREAS_marginal)){
  fit_model = PANCREAS_marginal[[gene]]$fit
  expres = count[[gene]]
  tmp = data.frame(expres,x)

  # plot(fit_model, main = paste0(gene,": Scatter Plot with GAM Curve"))
  plot(predict.gam(fit_model), col = "blue", pch = 16, xlab = "x", ylab = "y", main = paste0(gene,": Scatter Plot with GAM Predict results"))
  points(expres, col="red",pch=16)
  legend('topright', legend = c("Pred", "Label"),col = c("red","blue"),pch=c(1,16))
}
```

# 工作路径

```{r}
# 查看当前工作路径
getwd()
# 设置工作路径
setwd()
```

# single cell experiment包测试

read in data
```{r}
library(SummarizedExperiment)

# example_sce = readRDS((url("https://figshare.com/ndownloader/files/40581992")))
# saveRDS(example_sce,file = './test/test_data/exampledata1.rds')
example_sce <- readRDS("./test/test_data/exampledata1.rds")
example_sce
```

按照assay的名字来取出assay
```{r}
assays <- SummarizedExperiment::assays(example_sce)

dim(assays$X)
```

colData中存储的是细胞相关的数据,是一个dataframe
```{r}
coldata_mat <- data.frame(SummarizedExperiment::colData(example_sce))
primary_covariate <- c('pseudotime')
dat <- as.data.frame(coldata_mat[, primary_covariate, drop = FALSE])
```

# mgcv包测试

```{r}
# if formula obeys mgcv format
mu_formula = "s(spatial1, spatial2, bs = 'gp', k= 400)"
mu_mgcvform = grepl("^s\\(", mu_formula) | grepl("^te\\(", mu_formula)
mu_mgcvform
```

test mgcv
```{r}
library(mgcv)
test1 <- function(x,z,sx=0.3,sz=0.4) { 
  x <- x*20
 (pi**sx*sz)*(1.2*exp(-(x-0.2)^2/sx^2-(z-0.3)^2/sz^2)+
             0.8*exp(-(x-0.7)^2/sx^2-(z-0.8)^2/sz^2))
}
n <- 500

x <- runif(n)/20;z <- runif(n);
xs <- seq(0,1,length=30)/20;zs <- seq(0,1,length=30)
pr <- data.frame(x=rep(xs,30),z=rep(zs,rep(30,30)))
truth <- matrix(test1(pr$x,pr$z),30,30)
f <- test1(x,z)
y <- f + rnorm(n)*0.2

par(mfrow = c(2,2))

# Model with s()
b1 <- gam(y~s(x,z))
vis.gam(b1, plot.type = "contour", color = "terrain", main = "b1 product")

b6 <- gam(y~s(x)+s(z))
vis.gam(b1, plot.type = "contour", color = "terrain", main = "b6 product")

plot(predict(b1), predict(b6))

# b4 <- gam(y~ti(x,z))
# vis.gam(b4, plot.type = "contour", color = "terrain", main = "b4 product")

b5 <- gam(y~s(x)+s(z)+ti(x,z))
vis.gam(b5, plot.type = "contour", color = "terrain", main = "b5 product")

plot(predict(b1), predict(b5))

# Model with te()
b2 <- gam(y~te(x,z))
vis.gam(b2, plot.type = "contour", color = "terrain", main = "tensor product")

# Model with ti(a) + ti(b) + ti(a,b)
b3 <- gam(y~ ti(x) + ti(z) + ti(x,z))
vis.gam(b3, plot.type = "contour", color = "terrain", main = "tensor anova")

# Scatterplot of prediction b2/b3
plot(predict(b3), predict(b2))
```

# R其他函数测试

```{r}
mgcv_formula <- stats::formula("gene~cell_type + batch + test + offset(log(library))+s(pseudotime, k = 10, bs = 'cr')")

# all_covariates <- all.vars(mgcv_formula)[-1]

changeVars = c('batch','test')

formulaUpdate <- paste0(changeVars, collapse = "-")

mgcv_formula <- stats::update.formula(mgcv_formula, stats::as.formula(paste0("~.-", formulaUpdate)))

```

df and list
```{r}
df_list <- list(
  name = c("Alice", "Bob", "Charlie"),
  age = c(25, 30, 22),
  city = c("New York", "Los Angeles", "Chicago")
)
# wrong
# df_list[[c("name","age")]] 
length(df_list)

df_ <- data.frame(
  name = c("Alice", "Bob", "Charlie"),
  age = c(25, 30, 22),
  city = c("New York", "Los Angeles", "Chicago")
)

length(df_)
```

sapply and lapply
```{r}
my_list1 = list(c(1,2,3),matrix(c(0,1),nrow = 2),0)
my_list2 = list(1,2,3,4)
my_list3 = list(c(1,2,3),c(4,5,6))
l_result_list1 <- lapply(my_list1, function(x) x^2)
l_result_list2 <- lapply(my_list2, function(x) x^2)
s_result_list1 <- sapply(my_list1, function(x) x^2)
s_result_list2 <- sapply(my_list2, function(x) x^2)
s_result_list3 <- sapply(my_list3, function(x) x^2)
```

tapply
```{r}
# 创建一个向量 x 和一个因子变量 f
x <- c(10, 20, 15, 30, 25, 40)
f <- factor(c("A", "A", "B", "B", "C", "C"))

# 使用 tapply 对 x 进行分组汇总
result <- tapply(x, f, sum)
```

all
```{r}
all(sapply(iris$Species,is.factor))
```

